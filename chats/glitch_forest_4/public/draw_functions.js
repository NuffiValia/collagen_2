function drawBox(t,a,e,r,i,n,o){ctx.lineWidth=null!=r?r:lineWidth,ctx.strokeStyle=null!=e?e:lineColor,ctx.lineJoin="miter",i&&(ctx.fillStyle=n||"white",ctx.fillRect(t[0],t[1],a[0]-t[0],a[1]-t[1])),i&&!1===o||ctx.strokeRect(t[0],t[1],a[0]-t[0],a[1]-t[1])}function getSquareFromTwo(t,a){return[t,[a[0],t[1]],a,[t[0],a[1]]]}function getCutImg(t,a,e){var r,i,n=getBox(a),o=n[1][0]-n[0][0],c=n[1][1]-n[0][1],g=getPathArea(getCutSize(a,n[0][0],n[0][1]));!1!==e&&(saveImg?t.putImageData(saveImg,0,0):t.drawImage(img,0,0)),r=c,i=o;for(var u=t.getImageData(n[0][0],n[0][1],o,c),l=0;l<i;l++)for(var m=0;m<r;m++){var p=4*(m*i+l);t.isPointInPath(g,l,m)||(u.data[p+3]=0)}return[u,[n[0][0],n[0][1]],[n[1][0],n[1][1]]]}function addEffect(t,a,e){var r=getBox(a),i=r[1][0]-r[0][0],n=r[1][1]-r[0][1],o=getPathArea(getCutSize(a,r[0][0],r[0][1]));t.putImageData(saveImg,0,0);for(var c,g,u=[!1,!1,!1,!1],l=[!1,!1,!1,!1],m=0;m<e.length;m++)!1!==e[m]&&""!=e[m]&&null!=e[m]&&("+="==e[m].slice(0,2)?(u[m]="add",l[m]=parseInt(e[m].slice(2))):"-="==e[m].slice(0,2)?(u[m]="subtract",l[m]=parseInt(e[m].slice(2))):"*="==e[m].slice(0,2)?(u[m]="multiply",l[m]=parseInt(e[m].slice(2))):"/="==e[m].slice(0,2)?(u[m]="split",l[m]=parseInt(e[m].slice(2))):(u[m]="set",l[m]=parseInt(e[m])));c=n,g=i;for(var p=t.getImageData(r[0][0],r[0][1],i,n),f=0;f<g;f++)for(var d=0;d<c;d++){var h=4*(d*g+f);if(t.isPointInPath(o,f,d))for(m=0;m<4;m++)"set"==u[m]?p.data[h+m]=l[m]:"add"==u[m]?p.data[h+m]+=l[m]:"subtract"==u[m]?p.data[h+m]-=l[m]:"multiply"==u[m]?p.data[h+m]*=l[m]:"split"==u[m]&&(p.data[h+m]/=l[m])}t.putImageData(p,r[0][0],r[0][1])}function addEffectEval(ctx,area,script){var temporaryObj={},imgBox=getBox(area),cutWidth=imgBox[1][0]-imgBox[0][0],cutHeight=imgBox[1][1]-imgBox[0][1],cutArea=getCutSize(area,imgBox[0][0],imgBox[0][1]),cutPathArea=getPathArea(cutArea),H,W;ctx.putImageData(saveImg,0,0),H=cutHeight,W=cutWidth;for(var imgMap=ctx.getImageData(imgBox[0][0],imgBox[0][1],cutWidth,cutHeight),tmpX=0;tmpX<W;tmpX++)for(var tmpY=0;tmpY<H;tmpY++){var point=4*(tmpY*W+tmpX);if(ctx.isPointInPath(cutPathArea,tmpX,tmpY)){var arr_=runEval(imgMap.data[point],imgMap.data[point+1],imgMap.data[point+2],imgMap.data[point+3],tmpX,tmpY,W,H,temporaryObj);imgMap.data[point]=arr_[0],imgMap.data[point+1]=arr_[1],imgMap.data[point+2]=arr_[2],imgMap.data[point+3]=arr_[3]}}function runEval(R,G,B,A,X,Y,W,H,TMP){return eval(script),[R,G,B,A]}ctx.putImageData(imgMap,imgBox[0][0],imgBox[0][1])}function addEffectEvalToBorder(ctx,area,script,coeff_x,coeff_y){var temporaryObj={},imgBox=getBox(area),cutWidth=imgBox[1][0]-imgBox[0][0],cutHeight=imgBox[1][1]-imgBox[0][1],cutArea=getCutSize(area,imgBox[0][0],imgBox[0][1]),cutArea2=scaleArea(cutArea,coeff_x,coeff_y),cutPathArea=getPathArea(cutArea),cutPathArea2=getPathArea(cutArea2),H,W;ctx.putImageData(saveImg,0,0),H=cutHeight,W=cutWidth;for(var imgMap=ctx.getImageData(imgBox[0][0],imgBox[0][1],cutWidth,cutHeight),tmpX=0;tmpX<W;tmpX++)for(var tmpY=0;tmpY<H;tmpY++){var point=4*(tmpY*W+tmpX);if(ctx.isPointInPath(cutPathArea,tmpX,tmpY)&&!ctx.isPointInPath(cutPathArea2,tmpX,tmpY)){var arr_=runEval(imgMap.data[point],imgMap.data[point+1],imgMap.data[point+2],imgMap.data[point+3],tmpX,tmpY,W,H,temporaryObj);imgMap.data[point]=arr_[0],imgMap.data[point+1]=arr_[1],imgMap.data[point+2]=arr_[2],imgMap.data[point+3]=arr_[3]}}function runEval(R,G,B,A,X,Y,W,H,TMP){return eval(script),[R,G,B,A]}ctx.putImageData(imgMap,imgBox[0][0],imgBox[0][1])}function addEffectEvalToBorderPixels(ctx,area,script,iteration,lineW,border_inner_outer_box,step_iteration){var coeff_inner_outer=lineW;border_inner_outer_box&&(coeff_inner_outer=0);var temporaryObj={iteration:0},imgBox=getBox(area),cutWidth=imgBox[1][0]-imgBox[0][0],cutHeight=imgBox[1][1]-imgBox[0][1],cutArea=getCutSize(area,imgBox[0][0]-coeff_inner_outer,imgBox[0][1]-coeff_inner_outer),cutPathArea=getPathArea(cutArea),H,W;ctx.lineWidth=lineW,ctx.putImageData(saveImg,0,0),H=cutHeight+2*coeff_inner_outer,W=cutWidth+2*coeff_inner_outer;for(var imgMap=ctx.getImageData(imgBox[0][0]-coeff_inner_outer,imgBox[0][1]-coeff_inner_outer,cutWidth+2*coeff_inner_outer,cutHeight+2*coeff_inner_outer),it=0;it<iteration;it++)if(temporaryObj.iteration+=1,ctx.lineWidth-=step_iteration,border_inner_outer_box)for(var tmpX=0;tmpX<W;tmpX++)for(var tmpY=0;tmpY<H;tmpY++){var point=4*(tmpY*W+tmpX);if(ctx.isPointInPath(cutPathArea,tmpX,tmpY)&&ctx.isPointInStroke(cutPathArea,tmpX,tmpY)){var arr_=runEval(imgMap.data[point],imgMap.data[point+1],imgMap.data[point+2],imgMap.data[point+3],tmpX,tmpY,W,H,temporaryObj);imgMap.data[point]=arr_[0],imgMap.data[point+1]=arr_[1],imgMap.data[point+2]=arr_[2],imgMap.data[point+3]=arr_[3]}}else for(var tmpX=0;tmpX<W;tmpX++)for(var tmpY=0;tmpY<H;tmpY++){var point=4*(tmpY*W+tmpX);if(!ctx.isPointInPath(cutPathArea,tmpX,tmpY)&&ctx.isPointInStroke(cutPathArea,tmpX,tmpY)){var arr_=runEval(imgMap.data[point],imgMap.data[point+1],imgMap.data[point+2],imgMap.data[point+3],tmpX,tmpY,W,H,temporaryObj);imgMap.data[point]=arr_[0],imgMap.data[point+1]=arr_[1],imgMap.data[point+2]=arr_[2],imgMap.data[point+3]=arr_[3]}}function runEval(R,G,B,A,X,Y,W,H,TMP){return eval(script),[R,G,B,A]}ctx.putImageData(imgMap,imgBox[0][0]-coeff_inner_outer,imgBox[0][1]-coeff_inner_outer)}function createCode(script,context,sprites,sprites_group){var this_=context;eval(script)}function createContur(script){var area=[];return eval(script),area}function getImgToSprite(t,a,e,r){Promise.all([createImageBitmap(t[0])]).then((function(i){a.point=t[1],a.point2=t[2],a.frame=i[0],void 0===r||0!=r?a.frame_collection.push(a.frame):a.frame_collection[a.frame_index]=a.frame,0!=e&&a.render(a.id)}))}function drawImgData(t,a,e,r,i,n,o,c,g,u){Promise.all([createImageBitmap(a)]).then((function(a){if(t.save(),i){var l=getBox(r);t.translate(l[1][0],0),t.scale(-1,1),t.translate(-l[1][0]+(l[1][0]-l[0][0]),0)}if(n){l=getBox(r);t.translate(0,l[1][1]),t.scale(1,-1),t.translate(0,-l[1][1]+(l[1][1]-l[0][1]))}o&&c?t.drawImage(a[0],e[0],e[1],o,c):t.drawImage(a[0],e[0],e[1]),!1!==g&&(saveImg=t.getImageData(0,0,srcWidth,srcHeight)),t.restore(),u()}))}function rotateImgData(t,a,e,r,i,n,o){var c=[e[0]+(r[0]-e[0])/2,e[1]+(r[1]-e[1])/2];t.translate(c[0],c[1]),t.rotate(i),Promise.all([createImageBitmap(a)]).then((function(a){t.drawImage(a[0],-(r[0]-e[0])/2,-(r[1]-e[1])/2),t.rotate(-i),t.translate(-c[0],-c[1]),!1!==o&&(saveImg=t.getImageData(0,0,srcWidth,srcHeight)),n()}))}function rotationArea(t,a){for(var e=getBox(t),r=e[1][0]-e[0][0],i=e[1][1]-e[0][1],n=getCutSize(t,e[0][0]+r/2,e[0][1]+i/2),o=[],c=0;c<n.length;c++){var g=n[c][0]*Math.cos(a)-n[c][1]*Math.sin(a),u=n[c][1]*Math.cos(a)+n[c][0]*Math.sin(a);o.push([Math.round(g+e[0][0]+r/2),Math.round(u+e[0][1]+i/2)]),void 0!==n[c][2]&&(o[c]=o[c].concat(n[c].slice(2)))}return o}function scaleArea(t,a,e,r){for(var i,n,o=getBox(t),c=o[1][0]-o[0][0],g=o[1][1]-o[0][1],u=getCutSize(t,o[0][0]+c/2,o[0][1]+g/2),l=[],m=0;m<u.length;m++)i=a?c/2*a*(u[m][0]/(c/2)):u[m][0],n=e?g/2*e*(u[m][1]/(g/2)):u[m][1],l.push([Math.round(i+o[0][0]+c/2),Math.round(n+o[0][1]+g/2)]),u[m][2]&&(l[m][2]=u[m][2],a==e&&!1!==r&&(l[m][2]*=a));return l}function flipArea(t,a,e){for(var r,i,n=getBox(t),o=n[1][0]-n[0][0],c=n[1][1]-n[0][1],g=getCutSize(t,n[0][0],n[0][1]),u=[],l=0;l<g.length;l++)r=a?o-g[l][0]:g[l][0],i=e?c-g[l][1]:g[l][1],u.push([Math.round(r+n[0][0]),Math.round(i+n[0][1])]),g[l][2]&&(u[l][2]=g[l][2]);return u}function getSquareSide(t,a){var e=getBox(t),r=0,i=(e[1][0]-e[0][0])/2,n=(e[1][1]-e[0][1])/2,o=a[0]-e[0][0],c=e[1][0]-a[0],g=a[1]-e[0][1],u=e[1][1]-a[1];return a[0]<e[0][0]+i&&a[1]<e[0][1]+n&&(r=3,i/o>n/g&&(r=2)),a[0]<e[0][0]+i&&a[1]>e[0][1]+n&&(r=1,i/o>n/u&&(r=2)),a[0]>e[0][0]+i&&a[1]>e[0][1]+n&&(r=1,i/c>n/u&&(r=0)),a[0]>e[0][0]+i&&a[1]<e[0][1]+n&&(r=3,i/c>n/g&&(r=0)),r}function getBox(t){for(var a=[null,null],e=[null,null],r=0;r<t.length;r++)(null===a[0]||t[r][0]<a[0])&&(a[0]=t[r][0]),(null===e[0]||t[r][0]>e[0])&&(e[0]=t[r][0]),(null===a[1]||t[r][1]<a[1])&&(a[1]=t[r][1]),(null===e[1]||t[r][1]>e[1])&&(e[1]=t[r][1]);return[a,e]}function getBoxRound(t){var a=getBox(t);return a[0][0]=Math.round(a[0][0]),a[0][1]=Math.round(a[0][1]),a[1][0]=Math.round(a[1][0]),a[1][1]=Math.round(a[1][1]),a}function getCutSize(t,a,e){return t.map((function(t){var r=[t[0]-a,t[1]-e];return void 0!==t[2]&&(r=r.concat(t.slice(2))),r}))}function getImgData(t,a,e,r,i,n,o,c){var g,u;return"big"==t?(g=c.getImageData(e[0][0],e[0][1],i,o),u=c.getImageData(e[0][0],e[0][1],i,o)):(g=c.getImageData(a[0][0],a[0][1],r,n),u=c.getImageData(a[0][0],a[0][1],r,n)),[g,u]}function getDistance(t,a){return[t[0]-a[0],t[1]-a[1]]}function cutAndScale(t,a,e,r,i,n){var o,c=getBox(t),g=t[e],u=(c[1][0]-c[0][0])/2,l=(c[1][1]-c[0][1])/2;return null!=i&&0==i||ctx.putImageData(saveImg,0,0),"x"==n&&(o=g[0]<c[0][0]+u?cutAndScale_X(ctx,t,a,e,!0,r):cutAndScale_X(ctx,t,a,e,!1,r)),"y"==n&&(o=g[1]<c[0][1]+l?cutAndScale_Y(ctx,t,a,e,!0,r):cutAndScale_Y(ctx,t,a,e,!1,r)),null!=i&&0==i||(saveImg=ctx.getImageData(0,0,srcWidth,srcHeight)),o}function cutAndScale_(t,a,e,r,i){var n,o=getSquareSide(a,a[e]);return null!=i&&0==i||ctx.putImageData(saveImg,0,0),0==o?n=cutAndScale_X(ctx,t,a,e,!1,r):2==o?n=cutAndScale_X(ctx,t,a,e,!0,r):1==o?n=cutAndScale_Y(ctx,t,a,e,!1,r):3==o&&(n=cutAndScale_Y(ctx,t,a,e,!0,r)),null!=i&&0==i||(saveImg=ctx.getImageData(0,0,srcWidth,srcHeight)),n}function drawAreaPoints(t,a){null==a&&(a=!0),drawArea(t,a),drawAllSquares(t,halfPointSize)}function getCanvasPoint(t,a){var e=a.getBoundingClientRect();return[Math.round(t.clientX-e.left*(a.width/e.width)),Math.round(t.clientY-e.top*(a.height/e.height))]}function endArea(t,a){return t.length>=3&&Math.abs(a[0]-t[0][0])<=halfPointSize&&Math.abs(a[1]-t[0][1])<=halfPointSize&&(a[0]=t[0][0],a[1]=t[0][1],!0)}function getPathArea(t){let a=new Path2D;a.moveTo(t[0][0],t[0][1]);for(var e=1;e<t.length;e++)r(a,t,e)||a.lineTo(t[e][0],t[e][1]);return null!=t[0][2]&&t[0][2]>0&&r(a,t,0),a.closePath(),a;function r(t,a,e){var r=e-1;if(r<0&&(r=a.length-1),null!=a[r][2]&&a[r][2]>0&&(null==a[e][2]||0==a[e][2])){var i=getHalfDistance(a[e],a[r]);return t.lineTo(a[e][0],a[e][1]),!0}if(null!=a[e][2]&&a[e][2]>0){i=getHalfDistance(a[e],a[r]);null!=a[r][2]&&0!=a[r][2]||t.lineTo(i[0],i[1]);var n=e+1;n>a.length-1&&(n=0);var o=getHalfDistance(a[n],a[e]);return t.arcTo(a[e][0],a[e][1],o[0],o[1],a[e][2]),t.lineTo(o[0],o[1]),!0}}}function drawArea(t,a,e,r,i,n,o){if(t.length>1){ctx.strokeStyle=lineColor,r&&(ctx.strokeStyle=r),ctx.lineWidth=lineWidth,e&&(ctx.lineWidth=e),ctx.lineJoin="miter",ctx.beginPath(),ctx.moveTo(t[0][0],t[0][1]);for(var c=1;c<t.length;c++)a&&g(t,c)||ctx.lineTo(t[c][0],t[c][1]);if(a){if(g(t,0))return ctx.closePath(),i&&a&&u(),void(!1!==o&&ctx.stroke());ctx.closePath()}i&&a&&u(),!1!==o&&ctx.stroke()}function g(t,a,e){var r=a-1;if(r<0&&(r=t.length-1),null!=t[r][2]&&t[r][2]>0&&(null==t[a][2]||0==t[a][2])){var i=getHalfDistance(t[a],t[r]);return 1===a&&ctx.moveTo(i[0],i[1]),ctx.lineTo(t[a][0],t[a][1]),!0}if(null!=t[a][2]&&t[a][2]>0){i=getHalfDistance(t[a],t[r]);null==t[r][2]||0==t[r][2]?ctx.lineTo(i[0],i[1]):1===a&&ctx.moveTo(i[0],i[1]);var n=a+1;n>t.length-1&&(n=0);var o=getHalfDistance(t[n],t[a]);return ctx.arcTo(t[a][0],t[a][1],o[0],o[1],t[a][2]),ctx.lineTo(o[0],o[1]),!0}}function u(){ctx.fillStyle=n||"white",ctx.fill()}}function drawLine(t,a,e,r){ctx.strokeStyle=null!=e?e:lineColor,ctx.beginPath(),ctx.moveTo(t[0],t[1]),ctx.lineTo(a[0],a[1]),ctx.lineWidth=null!=r?r:lineWidth,ctx.stroke()}function drawSpriteGrid(t,a){for(var e=canvas.width,r=canvas.height,i=t;i<e;i+=t)drawLine([i,0],[i,r],grid_color,grid_weight);for(i=a;i<r;i+=a)drawLine([0,i],[e,i],grid_color,grid_weight)}function drawAllSquares(t,a){for(var e=0;e<t.length;e++)mouseSquare(t[e],a,e)}function mouseSquare(t,a,e){ctx.fillStyle="yellow",ctx.fillRect(t[0]-a,t[1]-a,2*a,2*a),null!=e&&(ctx.fillStyle="black",ctx.font=2*a+"px sans-serif",ctx.fillText(e,t[0]-a,t[1]+a/2,2*a))}function isClickOnPoint(t,a){for(var e=0;e<t.length;e++)if(Math.abs(a[0]-t[e][0])<=1.5*halfPointSize&&Math.abs(a[1]-t[e][1])<=1.5*halfPointSize)return e;return!1}function addPointTooArray(t,a){if(t.length<=a)return!1;var e=a+1;t.length-1==a&&(e=0);var r=[(t[e][0]-t[a][0])/2+t[a][0],(t[e][1]-t[a][1])/2+t[a][1]];return t.splice(a+1,0,r),a+1}function rmPointFromArray(t,a){return!(t.length-1<a)&&(t.splice(a,1),a)}function getHalfDistance(t,a){return[Math.round((t[0]-a[0])/2+a[0]),Math.round((t[1]-a[1])/2+a[1])]}function getLines(t,a,e){for(var r=a.split(" "),i=[],n=r[0],o=1;o<r.length;o++){var c=r[o];t.measureText(n+" "+c).width<e?n+=" "+c:(i.push(n),n=c)}return i.push(n),i}function cutAndScale_X(t,a,e,r,i,n,o){var c=r-1;0==r&&(c=a.length-1);var g=r+1;if(r>=a.length-1&&(g=0),a[c][1]>a[g][1]){var u=g;g=c,c=u}var l=e[r][0]-a[r][0];i&&(l*=-1);var m="big";l<0&&(m="little");var p,f,d=getBox(a),h=getBox(e),s=d[1][0]-d[0][0],x=d[1][1]-d[0][1],v=h[1][0]-h[0][0],_=h[1][1]-h[0][1],M=getCutSize(a,d[0][0],d[0][1]),I=getCutSize(e,h[0][0],h[0][1]),B=(getPathArea(M),getPathArea(I)),P=0;if("little"==m&&i&&(P=s-v),"big"==m?(p=_,f=v):(p=x,f=s),o)var A=(W=o[0]).data,S=o[1].data;else{var W,D=getImgData(m,d,h,s,v,x,_,t);A=(W=D[0]).data,S=D[1].data}for(var H=I[c][1],X=(I[c][0],I[r][1]),Y=(I[r][0],I[r][0]),b=M[r][0],w=X-H,T=1e-4,y=1,C=!1,z=0,E=1,k=0;k<p;k++){C=!1,k>X&&1==y&&(y=2,H=I[r][1],I[r][0],X=I[g][1],I[g][0],w=X-H),k>=H&&k<=X&&(C=!0,T=(k-H)/w,2==y&&(T=1-T));for(var R=!1,O=0;O<f;O++){!1===R&&(R=0);var j=4*(k*f+O+P),q=4*(k*f+P);t.isPointInPath(B,O,k)?(0===R&&(R=O),0===z&&(z=1),C?i?q+=4*Math.round(O+l*T*(1-O/(f*(E/f)))):("big"==m&&(q+=4*Math.round(O/(l*T/(Y-R-l*T)+1))),"little"==m&&(q+=4*Math.round(O/((b-R)/(b-R-l*T))))):q+=4*O,A[j]=S[q],A[j+1]=S[q+1],A[j+2]=S[q+2],A[j+3]=S[q+3]):(1===z&&R>0&&(E=O,z=0),n&&(A[j+3]=0))}}return n||t.putImageData(W,h[0][0]-P,h[0][1]),[W,[h[0][0]-P,h[0][1]],[h[1][0],h[1][1]]]}function cutAndScale_Y(t,a,e,r,i,n,o){var c=r-1;0==r&&(c=a.length-1);var g=r+1;if(r>=a.length-1&&(g=0),a[c][0]>a[g][0]){var u=g;g=c,c=u}var l=e[r][1]-a[r][1];i&&(l*=-1);var m="big";l<0&&(m="little");var p,f,d=getBox(a),h=getBox(e),s=d[1][0]-d[0][0],x=d[1][1]-d[0][1],v=h[1][0]-h[0][0],_=h[1][1]-h[0][1],M=getCutSize(a,d[0][0],d[0][1]),I=getCutSize(e,h[0][0],h[0][1]),B=(getPathArea(M),getPathArea(I)),P=0;if("little"==m&&i&&(P=x-_),"big"==m?(p=_,f=v):(p=x,f=s),o)var A=(W=o[0]).data,S=o[1].data;else{var W,D=getImgData(m,d,h,s,v,x,_,t);A=(W=D[0]).data,S=D[1].data}I[c][1];for(var H=I[c][0],X=(I[r][1],I[r][0]),Y=I[r][1],b=M[r][1],w=X-H,T=1e-4,y=1,C=!1,z=0,E=1,k=0;k<f;k++){C=!1,k>X&&1==y&&(y=2,H=I[r][0],I[r][1],X=I[g][0],I[g][1],w=X-H),k>=H&&k<=X&&(C=!0,T=(k-H)/w,2==y&&(T=1-T));for(var R=!1,O=0;O<p;O++){!1===R&&(R=0);var j,q,G=4*((O+P)*f+k);t.isPointInPath(B,k,O)?(0===R&&(R=O),0===z&&(z=1),C?(i?q=Math.round(O+l*T*(1-O/(p*(E/p)))):("big"==m&&(q=Math.round(O/(l*T/(Y-R-l*T)+1))),"little"==m&&(q=Math.round(O/((b-R)/(b-R-l*T))))),j=4*((q+P)*f+k)):j=4*((O+P)*f+k),A[G]=S[j],A[G+1]=S[j+1],A[G+2]=S[j+2],A[G+3]=S[j+3]):(n&&(A[G+3]=0),1===z&&R>0&&(E=O,z=0))}}return n||t.putImageData(W,h[0][0],h[0][1]-P),[W,[h[0][0],h[0][1]-P],[h[1][0],h[1][1]]]}