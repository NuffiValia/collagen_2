var gameUrl=window.location.origin+"/public/sprites.json";console.log(gameUrl);var personageId="personage",userId="user_"+Math.floor(1e3*Math.random()),numTiles=0,numUsers=1,pesonageType=null,typeP1="personage_1",typeP2="personage_2",typeP3="cat_sprite",typeP4="monkey",interval=100,timerId=0,click=!1;function movePersonage(e){if("ArrowUp"==e){if(1==click)return;click=!0,clearInterval(timerId),timerId=setInterval(move,interval,15,12,0,-10)}else if("ArrowDown"==e){if(1==click)return;click=!0,clearInterval(timerId),timerId=setInterval(move,interval,3,0,0,10)}else if("ArrowRight"==e){if(1==click)return;click=!0,clearInterval(timerId),timerId=setInterval(move,interval,11,8,10,0)}else if("ArrowLeft"==e){if(1==click)return;click=!0,clearInterval(timerId),timerId=setInterval(move,interval,7,4,-10,0)}}function stopPersonage(e){clearInterval(timerId),click=!1}modules.keydown=movePersonage,modules.keyup=stopPersonage;var dx,dy,mapPoint,smothStepX=1,smothStepY=1,moveStep=5,direction_=!1,distance=[0,0];function moveMouse(e){mapPoint=e.slice(0),direction_=directionMove(modules.personage.point,e),distance=[e[0]-modules.personage.point[0]-40,e[1]-modules.personage.point[1]-60],smothStep=Math.abs(distance[0]/distance[1]),smothStep<1?(smothStepX=smothStep,smothStepY=1):(smothStepX=1,smothStepY=Math.abs(distance[1]/distance[0])),dy=moveStep*smothStepY*(distance[1]/Math.abs(distance[1])),dx=moveStep*smothStepX*(distance[0]/Math.abs(distance[0])),clearInterval(timerId),timerId=setInterval(movePersonage_2,interval)}function movePersonage_2(){var e=!1;ctxTranslate[0]=-1*modules.personage.point[0]+srcWidth/2,ctxTranslate[1]=-1*modules.personage.point[1]+srcHeight/2;var o=modules.personage.point[0]-mapPoint[0],t=modules.personage.point[1]-mapPoint[1];function s(o,t){move(o,t,dx,dy),e&&(clearInterval(timerId),modules.personage.nextFrame(o))}o<=15*moveStep&&o>=-1*moveStep*15&&t<=15*moveStep&&t>=-1*moveStep*15&&(e=!0),"right"==direction_&&s(11,8),"left"==direction_&&s(7,4),"bottom"==direction_&&s(3,0),"top"==direction_&&s(15,12),"left-top"==direction_&&s(27,24),"left-bottom"==direction_&&s(19,16),"right-top"==direction_&&s(31,28),"right-bottom"==direction_&&s(23,20)}function directionMove(e,o){var t=[e[0]-o[0],e[1]-o[1]];return Math.abs(t[0])/Math.abs(t[1])>1?t[0]<0?"right":"left":t[1]<0?"bottom":"top"}function move(e,o,t,s){modules.personage.frame_index>o-1&&modules.personage.frame_index<e?modules.personage.nextFrame():modules.personage.nextFrame(o),modules.personage.move(t,s),collisionDetection(tiles_collision,modules.personage)&&modules.personage.move(-t,-s)}function animation(){numTiles=tiles_common.length,mode="animation",modules.animation&&(modules.animation.isOff=!0),HM.$$("emiter-operation-with").set("code"),modules.animation=animationLopLayer(tiles_bg,tiles_common,40),HM.state.chose_personage.htmlLink.style.display="block",HM.state.user_message.props.user_msg.setProp(""),maxTranslate=[-1e3,-1e3]}function createSocket(){if(socketjs.isSupported()){var e=socketjs.connect();e.send("newuser",{id:userId,point:modules.personage.point,frame_index:modules.personage.frame_index,pType:pesonageType}),e.disconnect((function(e){console.log("Temporarily disconnected.")})),e.reconnect((function(){return console.log("Reconnected."),"reconnected"})),e.receive("coord",(function(e){if(Object.keys(e).length!=numUsers){tiles_common.splice(0,tiles_common.length);for(var o=0;o<tiles_common_save.length;o++)HM.$props().sprites[tiles_common_save[o].parent]&&addTileCommon(tiles_common_save[o].id,HM.$props().sprites[tiles_common_save[o].parent],tiles_common_save[o].point);for(var t in e)e[t].id!=userId?addTileCommon(e[t].id,HM.$props().sprites[e[t].pType],e[t].point):addTileCommon(personageId,HM.$props().sprites[e[t].pType],e[t].point);for(o=0;o<tiles_common.length;o++)tiles_common[o].id==personageId&&(tiles_common[o]=modules.personage);numUsers=Object.keys(e).length}updateUsers(e)}));var o=setInterval((function(){e.send("coord",{id:userId,point:modules.personage.point,frame_index:modules.personage.frame_index,msg:modules.personage.message,pType:pesonageType})}),100);e.close((function(){console.log("Connection closed."),clearInterval(o)}))}else console.log("Your browser does not support WebSockets.")}function updateUsers(e){for(var o=0;o<tiles_common.length;o++)if(e[tiles_common[o].id]&&tiles_common[o].id!=userId){var t=e[tiles_common[o].id];tiles_common[o].point[0]=t.point[0],tiles_common[o].point[1]=t.point[1],tiles_common[o].nextFrame(t.frame_index),tiles_common[o].message=t.msg}}function addTileCommon(e,o,t){var s=new Tile(e,o,t);return s.message=!1,tiles_common.push(s),s}fetch(gameUrl).then((e=>{if(!e.ok)throw new Error(`HTTP error: ${e.status}`);return e.json()})).then((e=>{var o="data:image/png;base64,"+e.backImg,t=HM;for(var s in tiles_common_save=JSON.parse(e.tiles_common_save),tiles_bg_save=JSON.parse(e.tiles_bg_save),mainImgScale_x=1,mainImgScale_y=1,img.src=o,img.onload=function(){startImg()},e.sprites){createFromPC(s,t,!1,e.sprites[s])&&t.$$("emiter-create-sprite").set(s)}tiles_bg=[];for(var n=0;n<tiles_bg_save.length;n++)t.$props().sprites[tiles_bg_save[n].parent]&&tiles_bg.push(new Tile(tiles_bg_save[n].id,t.$props().sprites[tiles_bg_save[n].parent],tiles_bg_save[n].point));tiles_common=[];for(n=0;n<tiles_common_save.length;n++)t.$props().sprites[tiles_common_save[n].parent]&&addTileCommon(tiles_common_save[n].id,t.$props().sprites[tiles_common_save[n].parent],tiles_common_save[n].point);e.tiles_collision_save&&(tiles_collision=JSON.parse(e.tiles_collision_save)),animation(),ctx.fillStyle="black"})).catch((e=>console.error(`Fetch problem: ${e.message}`))),Tile.prototype.render_=function(){if(this.show&&(ctx.drawImage(this.frame,this.point[0],this.point[1],this.width,this.height),this.message)){var e=HM.$props().sprites.message;e.show=!0,e.point[0]=this.point[0]+40,e.point[1]=this.point[1]-90,e.point2[0]=e.point[0]+e.width,e.point2[1]=e.point[1]+e.height,e.textParam={text:this.message,lineHeight:15,font:"15px Balsamiq Sans",fillStyle:"black",padding_x_l:5,padding_x_r:5,padding_x:!1,padding_y:5,max_width:!1,textArr:!1},e.render_()}},CollageSprite.prototype.render_=function(){this.show&&(ctx.drawImage(this.frame,this.point[0],this.point[1],this.width,this.height),this.textParam&&this.fillText(this.point[0],this.point[1]))},StateMap.user_message={container:"user_message",props:[["user_msg_btn","mousedown","[name='user_msg_btn']"],["user_msg","inputvalue","[name='user_msg']"],["move_type_btn","mousedown","[name='move_type']"],["move_type","checkbox","[name='move_type']"]],methods:{user_msg_btn:function(){var e=this.props("user_msg").getProp();/[а-я]/i.test(e)?alert("чат не поддерживает кирилицу"):modules.personage.message=e},move_type_btn:function(){this.parent.props.move_type.getProp()?(isMoveCamera=!0,modules.keydown=movePersonage,modules.keyup=stopPersonage,modules.mousedown=function(){}):(isMoveCamera=!1,modules.mousedown=moveMouse,modules.keydown=function(){},modules.keyup=function(){})}}},StateMap.chose_personage={container:"chose_personage",props:[["personage_1","mousedown","[name='personage_1']"],["personage_2","mousedown","[name='personage_2']"],["personage_3","mousedown","[name='personage_3']"],["personage_4","mousedown","[name='personage_4']"]],methods:{personage_1:function(){this.parent.htmlLink.style.display="none",modules.personage=addTileCommon(personageId,this.$props().sprites[typeP1],[250,300]),pesonageType=typeP1,createSocket()},personage_2:function(){this.parent.htmlLink.style.display="none",modules.personage=addTileCommon(personageId,this.$props().sprites[typeP2],[250,300]),pesonageType=typeP2,createSocket()},personage_3:function(){this.parent.htmlLink.style.display="none",modules.personage=addTileCommon(personageId,this.$props().sprites[typeP3],[250,300]),pesonageType=typeP3,createSocket()},personage_4:function(){this.parent.htmlLink.style.display="none",modules.personage=addTileCommon(personageId,this.$props().sprites[typeP4],[250,300]),pesonageType=typeP4,createSocket()}}};