function CollageSprite(t,e,i,r){var a=getBox(e);this.type="sprite",this.id=i,this.frame=t,this.frame_collection=[],this.frame_index=0,this.point=a[0],this.point2=a[1],this.controlPoint=!1,this.controlSpritePoint=!1,this.area_1=e,this.area_2=e.slice(0),this.cursorOver=!1,this.currentOperation=!1,this.moveStart=!1,this.rotate=0,null!=r&&(this.rotate=r),this.show=!0,this.stamp_cursor=!1,this.scale_x=1,this.scale_y=1,this.width=this.point2[0]-this.point[0],this.height=this.point2[1]-this.point[1],this.border=!1,this.textParam=!1}function animationLop(t,e,i){var r={isOff:!1};let a=performance.now();return function s(){var o=performance.now();if(o-a>e)for(var h in a=o,ctx.clearRect(0,0,srcWidth,srcHeight),t)"sprite"==t[h].type?t[h].render_():t[h].render_(i);r.isOff||requestAnimationFrame(s)}(),r}function createFromPC(t,e,i,r){var a,s;if(null==(a=null==r?get_from_storage("spritesState",t):r).type&&(a.type="sprite"),"sprite_bone"==a.type?s=a.points:(s=a.area)||(s=a.cut_area),!0===i){var o=getBox(s);s=getCutSize(s,o[0][0],o[0][1])}if("sprite"==a.type){var h=[];a.imgAsURL&&(a.imgAsURL_collection=[a.imgAsURL]);for(var n=0;n<a.imgAsURL_collection.length;n++){var l="data:image/png;base64,"+a.imgAsURL_collection[n],p=new Image;p.src=l,h.push(p)}getBox(s);var c=new CollageSprite(h[0],s,t,a.rotate);return null==a.scale_x?c.scale_x=1:c.scale_x=a.scale_x,null==a.scale_y?c.scale_y=1:c.scale_y=a.scale_y,null!=a.controlSpritePoint&&(c.controlSpritePoint=a.controlSpritePoint),null!=a.controlPoint&&(c.controlPoint=a.controlPoint),null!=a.textParam&&(c.textParam=a.textParam),null!=a.border&&(c.border=a.border),null!=a.show&&(c.show=a.show),c.type="sprite",e.$props("sprites")[t]=c,c.frame_collection=h,c.frame_collection[0].onload=function(){e.$methods().renderAll()},c}return a}function removeFromPC(t){var e=get_from_storage("spritesState");delete e[t],save_in_storage(e,"spritesState")}CollageSprite.prototype.nextFrame=function(t){this.frame_index+=1,(t||0===t)&&(this.frame_index=t),this.frame_index>this.frame_collection.length-1&&(this.frame_index=0),this.frame=this.frame_collection[this.frame_index]},CollageSprite.prototype.prevFrame=function(t){this.frame_index-=1,(t||0===t)&&(this.frame_index=t),this.frame_index<0&&(this.frame_index=this.frame_collection.length-1),this.frame=this.frame_collection[this.frame_index]},CollageSprite.prototype.render=function(t,e,i){if(null==i&&(i={}),this.show&&(this.id!=t||1!=i.not_render)){var r=this.area_1;"move"==e&&this.id==t&&(r=this.area_2);var a=this.point,s=this.width,o=this.height;if(1==this.stamp_cursor&&this.stamp_cursor_point&&(a=this.stamp_cursor_point),0!==this.rotate){var h=s/2,n=o/2;r=rotationArea(this.area_1,this.rotate),"move"==e&&this.id==t&&(r=rotationArea(this.area_2,this.rotate));var l=[this.point[0]+h,this.point[1]+n];if(1==this.stamp_cursor&&(l=[a[0]+h,a[1]+n]),ctx.save(),ctx.translate(l[0],l[1]),ctx.rotate(this.rotate),ctx.drawImage(this.frame,-h,-n,s,o),this.border&&this.border.size>0){if(ctx.restore(),1==this.stamp_cursor){l=[a[0]+h,a[1]+n];var p=getBox(this.area_1);r=getCutSize(this.area_1,p[0][0]-l[0]+(p[1][0]-p[0][0])/2,p[0][1]-l[1]+(p[1][1]-p[0][1])/2);r=rotationArea(r,this.rotate)}drawArea(r,!0,this.border.size,this.border.color),ctx.save(),ctx.translate(l[0],l[1]),ctx.rotate(this.rotate)}this.textParam&&""!=this.textParam.text&&this.fillText(-h,-n),ctx.restore()}else{if(ctx.drawImage(this.frame,a[0],a[1],s,o),this.border){if(1==this.stamp_cursor){p=getBox(r);r=getCutSize(r,p[0][0]-a[0]-s/2+(p[1][0]-p[0][0])/2,p[0][1]-a[1]-o/2+(p[1][1]-p[0][1])/2)}drawArea(r,!0,this.border.size,this.border.color)}this.textParam&&this.fillText(a[0],a[1])}this.id==t&&0==this.stamp_cursor&&(1==i.showPoints?drawAreaPoints(r):drawArea(r,!0),1==i.showBox&&drawBox(this.point,this.point2,"yellow",1))}},CollageSprite.prototype.render_=function(){if(this.show)if(0!==this.rotate){var t=this.width/2,e=this.height/2,i=(rotationArea(this.area_1,this.rotate),[this.point[0]+t,this.point[1]+e]);ctx.save(),ctx.translate(i[0],i[1]),ctx.rotate(this.rotate),ctx.drawImage(this.frame,-t,-e,this.width,this.height),ctx.restore()}else ctx.drawImage(this.frame,this.point[0],this.point[1],this.width,this.height)},CollageSprite.prototype.move=function(t,e){var i=getCutSize(this.area_1,-1*t,-1*e);this.setAreas(i)},CollageSprite.prototype.moveConer=function(t,e,i){var r=0;i&&(r=this.height);var a=this.area_1,s=getBox(a);a=getCutSize(a,s[0][0]-t,s[0][1]-e+r),this.setAreas(a)},CollageSprite.prototype.moveCenter=function(t,e){var i=this.area_1,r=getBox(i);i=getCutSize(i,r[0][0]-t+this.width/2,r[0][1]-e+this.height/2),this.setAreas(i)},CollageSprite.prototype.rotateFi=function(t){this.rotate=parseInt(t)*Math.PI/180},CollageSprite.prototype.scale=function(t,e){if(t!=this.scale_x||e!=this.scale_y){var i=t/this.scale_x,r=e/this.scale_y,a=scaleArea(this.area_1,i,r,!1);this.area_1=a.slice(0);var s=getBox(a);if(this.point=s[0],this.point2=s[1],this.width=this.point2[0]-this.point[0],this.height=this.point2[1]-this.point[1],this.scale_x=t,this.scale_y=e,0!=this.textParam&&(this.textParam.max_width=!1,this.textParam.textArr=!1),t==e&&1!==this.scale_x&&1!==this.scale_y||t==e&null==this.round_scale){var o=i;null==this.round_scale&&(o=t);for(var h=0;h<this.area_1.length;h++)this.area_1[h][2]&&(this.round_scale=!0,this.area_1[h][2]=this.area_1[h][2]*o)}}},CollageSprite.prototype.click=function(t){},CollageSprite.prototype.keydown=function(t){},CollageSprite.prototype.moveByLine=function(t,e,i,r,a){var s=0,o=this,h="moveCenter";i&&1==i&&(h="moveConer");let n=performance.now();!function i(){var l=performance.now();l-n>e&&(n=l,o.nextFrame(t[s][2]),o[""+h](t[s][0],t[s][1],!0),s++),s>t.length-1?r&&r(a):requestAnimationFrame(i)}()},CollageSprite.prototype.mousedown=function(t,e,i){if(this.cursorOver&&!1===this.moveStart&&!1===this.currentOperation)return this.moveStart=t,this.currentOperation="move",void(this.savePoints={point:this.point.slice(0),point2:this.point2.slice(0)});if(!0===this.stamp_cursor){t=getCanvasPoint(e,canvas,i);this.stamp_cursor_point=[t[0]-this.getHalfW(),t[1]-this.getHalfH()],ctx.putImageData(saveImg,0,0),saveStep(saveImg,i.$props().commonProps.area_1),this.render(),saveImg=ctx.getImageData(0,0,srcWidth,srcHeight),i.$methods().renderAll()}},CollageSprite.prototype.mousemove=function(t,e,i){if("move"===this.currentOperation){var r=[this.moveStart[0]-t[0],this.moveStart[1]-t[1]];this.area_2=getCutSize(this.area_1,r[0],r[1]),this.point=[this.savePoints.point[0]-r[0],this.savePoints.point[1]-r[1]],this.point2=[this.savePoints.point2[0]-r[0],this.savePoints.point2[1]-r[1]],e.$methods().renderAll("move")}if(!0===this.stamp_cursor){t=getCanvasPoint(i,canvas,e);this.stamp_cursor_point=[t[0]-this.getHalfW(),t[1]-this.getHalfH()],e.$methods().renderAll()}},CollageSprite.prototype.mouseup=function(t,e){if("move"==this.currentOperation){this.currentOperation=!1;var i=[this.moveStart[0]-e[0],this.moveStart[1]-e[1]];this.area_2=getCutSize(this.area_1,i[0],i[1]),this.area_1=this.area_2.slice(0),this.point=[this.savePoints.point[0]-i[0],this.savePoints.point[1]-i[1]],this.point2=[this.savePoints.point2[0]-i[0],this.savePoints.point2[1]-i[1]],t.$methods().renderAll(),this.moveStart=!1}},CollageSprite.prototype.cursorOver_=function(t,e){var i=this.area_1;0!==this.rotate&&(i=rotationArea(this.area_1,this.rotate));var r=getPathArea(i);ctx.isPointInPath(r,t[0],t[1])?(void 0!==e&&!0!==e||(document.body.style.cursor="pointer"),this.cursorOver=!0):(document.body.style.cursor="auto",this.cursorOver=!1)},CollageSprite.prototype.setAreas=function(t){this.area_1=t.slice(0);var e=getBox(t);this.point=e[0],this.point2=e[1]},CollageSprite.prototype.flip=function(t,e,i){ctx.clearRect(0,0,srcWidth,srcHeight);var r=this.point2[0]-this.point[0],a=this.point2[1]-this.point[1],s=r/2,o=a/2,h=[this.point[0]+s,this.point[1]+o];ctx.save(),ctx.translate(h[0],h[1]),t&&ctx.scale(-1,1),e&&ctx.scale(1,-1),ctx.drawImage(this.frame,-s,-o,r,a),ctx.restore();var n=flipArea(this.area_1,t,e);this.area_1=n.slice(0),this.area_2=n.slice(0);var l=getCutImg(ctx,n,!1);i.$methods().renderAll(!1,{not_render:!0}),getImgToSprite(l,this,!0,!1)},CollageSprite.prototype.fillText=function(t,e){this.textParam.max_width||(this.textParam.max_width=this.point2[0]-this.point[0],this.textParam.padding_x_l&&(this.textParam.max_width-=this.textParam.padding_x_l),null!=this.textParam.padding_x_r&&(this.textParam.max_width-=this.textParam.padding_x_r,this.textParam.padding_x=this.textParam.padding_x_r),this.textParam.padding_x_r||this.textParam.padding_x_l||!this.textParam.padding_x||(this.textParam.max_width-=2*this.textParam.padding_x)),ctx.fillStyle=this.textParam.fillStyle,ctx.font=this.textParam.font,this.textParam.textArr||(this.textParam.textArr=getLines(ctx,this.textParam.text,this.textParam.max_width));for(var i=0;i<this.textParam.textArr.length;i++)ctx.fillText(this.textParam.textArr[i],t+this.textParam.padding_x,e+this.textParam.padding_y+this.textParam.lineHeight*(i+1))},CollageSprite.prototype.saveOnPC=function(){var t=this.id,e=get_from_storage("spritesState");null==e&&(e={}),e[t]=this.getToSave();try{save_in_storage(e,"spritesState")}catch(t){return void alert(t)}console.log("спрайт "+t+" сохранен")},CollageSprite.prototype.getToSave=function(){this.frame;for(var t=[],e=0;e<this.frame_collection.length;e++)t.push(getBase64Image(this.frame_collection[e]));return{area:this.area_1.slice(0),imgAsURL_collection:t,rotate:this.rotate,scale_x:this.scale_x,scale_y:this.scale_y,controlSpritePoint:this.controlSpritePoint,controlPoint:this.controlPoint,textParam:this.textParam,border:this.border,type:"sprite",show:this.show}},CollageSprite.prototype.getHalfW=function(){return(this.point2[0]-this.point[0])/2},CollageSprite.prototype.getHalfH=function(){return(this.point2[1]-this.point[1])/2};